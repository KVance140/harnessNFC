<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>NFC Harness Inventory T3803</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 16px;
    padding-bottom: 180px;
    font-size: 18px;
  }

  select, input {
    font-size: 20px;
    padding: 14px;
    margin: 8px 0;
    width: 100%;
  }

  #status {
    font-weight: bold;
    padding: 14px;
    margin-bottom: 12px;
    text-align: center;
    border-radius: 8px;
  }

  .ready { background:#e6f4ea; color:#1e7e34; }
  .scanning { background:#e7f1ff; color:#0d6efd; }
  .stopped { background:#fdecea; color:#b02a37; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
  }

  #editForm {
    margin-top: 16px;
  }

  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 2px solid #ccc;
    padding: 12px;
  }

  button {
    font-size: 22px;
    padding: 16px;
    width: 100%;
    margin-top: 8px;
  }
</style>
</head>

<body>

<h3>NFC Harness Inventory - T3803 - Version 2</h3>

<div id="status" class="ready">Ready to Scan</div>

<table>
  <thead>
    <tr>
      <th>Serial</th>
      <th>Location</th>
      <th>Size</th>
      <th>Shift</th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="editForm" style="display:none;">
  <h4>Edit Harness</h4>

  <select id="location">
    <option value="" disabled selected hidden>Warehouse Location</option>
    <option>Warehouse</option>
    <option>MBP</option>
    <option>ICQA</option>
    <option>EF</option>
    <option>Other</option>
  </select>

  <select id="size">
    <option value="" disabled selected hidden>Harness Size</option>
    <option>U</option>
    <option>XS</option>
    <option>S</option>
    <option>M</option>
    <option>L</option>
    <option>XL</option>
  </select>

  <select id="shift">
    <option value="" disabled selected hidden>Shift</option>
    <option>A1</option>
    <option>A2</option>
    <option>B1</option>
    <option>B2</option>
    <option>E&F</option>
  </select>

  <button onclick="saveEdit()">Save</button>
</div>

<div id="bottomBar">
  <select id="mode">
    <option value="continue">Scan & Continue</option>
    <option value="edit">Scan & Edit</option>
  </select>

  <button id="scanBtn" onclick="toggleScan()">Start Scanning</button>
  <button onclick="selectSharedFolder()">Select Shared Folder</button>
  <button onclick="loadFromSharedFolder()">Load From Shared Folder</button>
  <button onclick="exportCSV()">Export CSV</button>
  <button onclick="clearRecords()">Clear All Records</button>
</div>

<script>
let reader = null;
let scanning = false;
let records = [];
let currentSerial = null;
let sharedFolderHandle = null;

/* ---------- Utilities ---------- */

function setStatus(text, css) {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = css;
}

function normalizeSerial(serial) {
  // Remove colons, split into bytes, reverse byte order
  const clean = serial.replace(/:/g, "");
  return clean.match(/.{2}/g).reverse().join("").toUpperCase();
}

function getDateOnly() {
  return new Date().toLocaleDateString();
}

/* ---------- Persistence ---------- */

function saveRecords() {
  localStorage.setItem("harnessRecords", JSON.stringify(records));
}

function loadRecords() {
  const saved = localStorage.getItem("harnessRecords");
  if (saved) {
    records = JSON.parse(saved);
    renderTable();
  }
}

/* ---------- Shared Folder ---------- */

async function selectSharedFolder() {
  sharedFolderHandle = await window.showDirectoryPicker();
}

async function writeLiveJSON() {
  if (!sharedFolderHandle) return;

  const fileHandle = await sharedFolderHandle.getFileHandle(
    "harness_inventory_live.json",
    { create: true }
  );

  const writable = await fileHandle.createWritable();
  await writable.write(JSON.stringify(records, null, 2));
  await writable.close();
}

async function loadFromSharedFolder() {
  const [fileHandle] = await window.showOpenFilePicker({
    types: [{ description: "JSON", accept: { "application/json": [".json"] } }]
  });

  const file = await fileHandle.getFile();
  records = JSON.parse(await file.text());
  saveRecords();
  renderTable();
}

/* ---------- NFC ---------- */

async function toggleScan() {
  if (scanning) {
    reader.onreading = null;
    reader = null;
    scanning = false;
    document.getElementById("scanBtn").textContent = "Start Scanning";
    setStatus("Scanning Stopped", "stopped");
    return;
  }

  reader = new NDEFReader();
  await reader.scan();
  scanning = true;

  document.getElementById("scanBtn").textContent = "Stop Scanning";
  setStatus("Scanningâ€¦ Tap NFC Tag", "scanning");

  reader.onreading = ({ serialNumber }) => {
    if (!scanning) return;

    const serial = normalizeSerial(serialNumber);
    const mode = document.getElementById("mode").value;

    if (mode === "continue") {
      addRecord(serial);
    } else {
      currentSerial = serial;
      document.getElementById("editForm").style.display = "block";
    }
  };
}

/* ---------- Records ---------- */

function addRecord(serial, location="", size="", shift="") {
  records.push({
    serial,
    location,
    size,
    shift,
    date: getDateOnly()
  });

  saveRecords();
  writeLiveJSON();
  renderTable();
}

function saveEdit() {
  addRecord(
    currentSerial,
    location.value,
    size.value,
    shift.value
  );

  location.value = "";
  size.value = "";
  shift.value = "";
  document.getElementById("editForm").style.display = "none";
}

/* ---------- Table ---------- */

function renderTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  records.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.serial}</td>
        <td>${r.location}</td>
        <td>${r.size}</td>
        <td>${r.shift}</td>
        <td>${r.date}</td>
      </tr>`;
  });
}

/* ---------- Export / Clear ---------- */

function exportCSV() {
  const header = "Serial,Location,Size,Shift,Date\n";
  const rows = records.map(r =>
    `${r.serial},${r.location},${r.size},${r.shift},${r.date}`
  ).join("\n");

  const blob = new Blob([header + rows], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "harness_inventory.csv";
  a.click();
}

function clearRecords() {
  if (!confirm("Delete all records on this device?")) return;
  records = [];
  localStorage.removeItem("harnessRecords");
  renderTable();
}

/* ---------- Init ---------- */

loadRecords();
</script>

</body>
</html>
