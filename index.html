<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>NFC Harness Inventory T3803</title>

<style>
  body {
    font-family: Arial, sans-serif;
    padding: 16px;
    padding-bottom: 140px;
    font-size: 18px;
  }

  select, input {
    font-size: 20px;
    padding: 14px;
    margin: 8px 0;
    width: 100%;
  }

  #status {
    font-weight: bold;
    padding: 14px;
    margin-bottom: 12px;
    text-align: center;
    border-radius: 8px;
  }

  .ready { background: #e6f4ea; color: #1e7e34; }
  .scanning { background: #e7f1ff; color: #0d6efd; }
  .stopped { background: #fdecea; color: #b02a37; }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 16px;
  }

  th, td {
    border: 1px solid #ccc;
    padding: 10px;
  }

  #editForm {
    margin-top: 16px;
  }

  #bottomBar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: #fff;
    border-top: 2px solid #ccc;
    padding: 12px;
  }

  button {
    font-size: 22px;
    padding: 16px;
    width: 100%;
    margin-top: 8px;
  }
</style>
</head>

<body>

<h3>NFC Harness Inventory - T3803 - Version 1</h3>

<div id="status" class="ready">Ready to Scan</div>

<table>
  <thead>
    <tr>
      <th>Serial</th>
      <th>Location</th>
      <th>Size</th>
      <th>Shift</th>
      <th>Date Scanned</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<div id="editForm" style="display:none;">
  <h4>Edit Harness</h4>

  <select id="location" required>
    <option value="" disabled selected hidden>Warehouse Location</option>
    <option value="Warehouse">Warehouse</option>
    <option value="MBP">MBP</option>
    <option value="ICQA">ICQA</option>
    <option value="EF">EF</option>
    <option value="Other">Other</option>
  </select>

  <select id="size" required>
    <option value="" disabled selected hidden>Harness Size</option>
    <option value="U">Universal</option>
    <option value="XS">Extra Small</option>
    <option value="S">Small</option>
    <option value="M">Medium</option>
    <option value="L">Large</option>
    <option value="XL">Extra Large</option>
  </select>

  <select id="shift" required>
    <option value="" disabled selected hidden>Shift</option>
    <option value="A1">A1</option>
    <option value="A2">A2</option>
    <option value="B1">B1</option>
    <option value="B2">B2</option>
    <option value="EF">E&F</option>
  </select>

  <button onclick="saveEdit()">Save</button>
</div>

<div id="bottomBar">
  <select id="mode">
    <option value="continue">Scan & Continue</option>
    <option value="edit">Scan & Edit</option>
  </select>

  <button id="scanBtn" onclick="toggleScan()">Start Scanning</button>
  <button onclick="exportCSV()">Export CSV</button>
</div>

<script>
let reader = null;
let scanning = false;
let records = [];
let currentSerial = null;

function setStatus(text, css) {
  const s = document.getElementById("status");
  s.textContent = text;
  s.className = css;
}

function formatSerial(serial) {
  const clean = serial.replace(/:/g, "").toUpperCase();
  return clean.match(/.{2}/g).reverse().join("");
}

function getDateOnly() {
  return new Date().toLocaleDateString();
}

async function toggleScan() {
  if (!scanning) {
    reader = new NDEFReader();
    await reader.scan();
    scanning = true;

    document.getElementById("scanBtn").textContent = "Stop Scanning";
    setStatus("Scanningâ€¦ Tap NFC Tag", "scanning");

reader.onreading = ({ serialNumber }) => {
  if (!scanning) return;   

  const serial = formatSerial(serialNumber);
  const mode = document.getElementById("mode").value;

  if (mode === "continue") {
    addRecord(serial);
  } else {
    currentSerial = serial;
    document.getElementById("editForm").style.display = "block";
  }
};
  } else {
  scanning = false;

  document.getElementById("scanBtn").textContent = "Start Scanning";
  setStatus("Scanning Stopped", "stopped");
}

}

function addRecord(serial, location="", size="", shift="") {
  records.push({
    serial,
    location,
    size,
    shift,
    date: getDateOnly()
  });
  renderTable();
}

function saveEdit() {
  const locationVal = document.getElementById("location").value;
  const sizeVal = document.getElementById("size").value;
  const shiftVal = document.getElementById("shift").value;

  addRecord(currentSerial, locationVal, sizeVal, shiftVal);

  document.getElementById("location").selectedIndex = 0;
  document.getElementById("size").selectedIndex = 0;
  document.getElementById("shift").selectedIndex = 0;

  document.getElementById("editForm").style.display = "none";
}

function renderTable() {
  const tbody = document.getElementById("tableBody");
  tbody.innerHTML = "";

  records.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.serial}</td>
        <td>${r.location}</td>
        <td>${r.size}</td>
        <td>${r.shift}</td>
        <td>${r.date}</td>
      </tr>`;
  });
}

function exportCSV() {
  const header = "Serial,Location,Size,Shift,Date\n";
  const rows = records.map(r =>
    `${r.serial},${r.location},${r.size},${r.shift},${r.date}`
  ).join("\n");

  const blob = new Blob([header + rows], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "harness_inventory.csv";
  a.click();
}
</script>

</body>
</html>
